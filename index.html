<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CoPack — ZIP/RAR Extractor & ZIP Creator</title>
  <!-- Tailwind CSS for quick styling -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    :root{
      /* Brand colours */
      --brand: #0927eb;
      --brand-light: #eef1ff;
      --brand-dark: #0b22c5;
    }
    /* Tabs styling */
    .tab {
      padding: 0.5rem 1rem;
      cursor: pointer;
      border: 1px solid var(--brand);
      border-bottom: none;
      border-radius: 0.5rem 0.5rem 0 0;
      margin-right: 0.25rem;
      color: var(--brand);
      background-color: #fff;
    }
    .tab.active {
      background-color: var(--brand);
      color: #fff;
    }
    .tab:not(.active):hover {
      background-color: var(--brand-light);
    }
    /* Drop zone */
    .drop-zone {
      border: 2px dashed var(--brand);
      background: var(--brand-light);
      padding: 1.5rem;
      text-align: center;
      border-radius: 0.75rem;
      color: #4b5563;
      transition: background-color 0.2s;
    }
    .drop-zone.dragover {
      background: var(--brand);
      color: #fff;
    }
    /* Progress bar */
    .progress {
      position: relative;
      background-color: #e5e7eb;
      border-radius: 0.375rem;
      overflow: hidden;
      height: 0.75rem;
      margin-top: 0.5rem;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background-color: var(--brand);
      transition: width 0.2s;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <main class="max-w-5xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl font-semibold text-center" style="color: var(--brand)">
        Estrattore ZIP/RAR & Creatore ZIP
      </h1>
      <p class="text-center text-gray-600 mt-1">Con questo strumento puoi estrarre file da archivi .zip e .rar e creare un archivio ZIP dai tuoi file locali. Tutto avviene sul tuo dispositivo: nessun upload.</p>
    </header>
    <!-- Tabs navigation -->
    <div class="flex mb-4 border-b border-brand-500">
      <button id="tab-extract" class="tab active">Estrai ZIP/RAR</button>
      <button id="tab-create" class="tab">Crea ZIP</button>
    </div>
    <!-- Extraction section -->
    <section id="section-extract" class="space-y-4">
      <div>
        <label for="archiveInput" class="block mb-2 text-sm font-medium text-gray-700">Seleziona un archivio (.zip o .rar)</label>
        <input id="archiveInput" type="file" accept=".zip,.rar" class="w-full border rounded px-3 py-2" />
      </div>
      <div id="archiveDrop" class="drop-zone">Trascina qui il tuo archivio (.zip o .rar)</div>
      <div id="archiveInfo" class="hidden space-y-2">
        <div class="flex items-center justify-between">
          <div>
            <strong>Contenuto archivio:</strong>
          </div>
          <div class="flex space-x-2">
            <button id="btnSelectAll" class="px-3 py-1 text-sm border rounded" style="border-color: var(--brand); color: var(--brand)">Seleziona tutto</button>
            <button id="btnDeselectAll" class="px-3 py-1 text-sm border rounded" style="border-color: var(--brand); color: var(--brand)">Deseleziona tutto</button>
            <button id="btnDownloadSelected" class="px-3 py-1 text-sm border rounded" style="background-color: var(--brand); color: #fff">Scarica selezionati (ZIP)</button>
          </div>
        </div>
        <div id="archiveList" class="mt-2 border rounded p-3 max-h-60 overflow-y-auto"></div>
        <div id="extractSummary" class="text-sm text-gray-600"></div>
        <div id="extractProgressContainer" class="hidden">
          <div class="progress">
            <div id="extractProgressBar" class="progress-bar"></div>
          </div>
          <div id="extractProgressText" class="text-xs text-gray-600 mt-1"></div>
        </div>
      </div>
    </section>
    <!-- Creation section -->
    <section id="section-create" class="space-y-4 hidden">
      <div>
        <label for="filesInput" class="block mb-2 text-sm font-medium text-gray-700">Seleziona file o cartelle per creare lo ZIP</label>
        <input id="filesInput" type="file" multiple webkitdirectory class="w-full border rounded px-3 py-2" />
      </div>
      <div id="filesList" class="border rounded p-3 max-h-60 overflow-y-auto hidden"></div>
      <div class="flex flex-col md:flex-row md:items-end md:space-x-4 space-y-2 md:space-y-0">
        <div class="flex-1">
          <label class="block text-sm text-gray-700 mb-1" for="zipName">Nome archivio (senza estensione)</label>
          <input id="zipName" type="text" placeholder="archivio" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1" for="zipLevel">Livello compressione</label>
          <select id="zipLevel" class="w-full border rounded px-3 py-2">
            <option value="0">0 - Nessuna compressione</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5" selected>5 (default)</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9 - Massima</option>
          </select>
        </div>
        <div>
          <button id="btnCreateZip" class="px-4 py-2 rounded" style="background-color: var(--brand); color: #fff">Crea ZIP</button>
        </div>
      </div>
      <div id="createSummary" class="text-sm text-gray-600"></div>
      <div id="createProgressContainer" class="hidden">
        <div class="progress">
          <div id="createProgressBar" class="progress-bar"></div>
        </div>
        <div id="createProgressText" class="text-xs text-gray-600 mt-1"></div>
      </div>
    </section>
  </main>
  <!-- Dependencies -->
  <!-- Unarchiver.js: supports ZIP, RAR, TAR, GZ, XZ, BZ2 -->
  <script src="https://xenova.github.io/unarchiver.js/dist/unarchiver.min.js"></script>
  <!-- JSZip for ZIP creation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    // Utility: format bytes to human readable
    function humanReadable(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
      return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
    }

    // Tab switching
    const tabExtract = document.getElementById('tab-extract');
    const tabCreate  = document.getElementById('tab-create');
    const sectionExtract = document.getElementById('section-extract');
    const sectionCreate  = document.getElementById('section-create');
    tabExtract.addEventListener('click', () => {
      tabExtract.classList.add('active');
      tabCreate.classList.remove('active');
      sectionExtract.classList.remove('hidden');
      sectionCreate.classList.add('hidden');
    });
    tabCreate.addEventListener('click', () => {
      tabCreate.classList.add('active');
      tabExtract.classList.remove('active');
      sectionCreate.classList.remove('hidden');
      sectionExtract.classList.add('hidden');
    });

    // Extraction variables
    let archiveEntries = [];
    let selectedEntries = [];
    const archiveInput = document.getElementById('archiveInput');
    const archiveDrop = document.getElementById('archiveDrop');
    const archiveInfo = document.getElementById('archiveInfo');
    const archiveList = document.getElementById('archiveList');
    const extractProgressContainer = document.getElementById('extractProgressContainer');
    const extractProgressBar = document.getElementById('extractProgressBar');
    const extractProgressText = document.getElementById('extractProgressText');
    const extractSummary = document.getElementById('extractSummary');
    const btnSelectAll = document.getElementById('btnSelectAll');
    const btnDeselectAll = document.getElementById('btnDeselectAll');
    const btnDownloadSelected = document.getElementById('btnDownloadSelected');

    // Handle file input change
    archiveInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      handleArchiveFile(file);
    });

    // Drag & drop handlers
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    ['dragenter','dragover','dragleave','drop'].forEach(evt => {
      archiveDrop.addEventListener(evt, preventDefaults, false);
    });
    archiveDrop.addEventListener('dragover', (e) => {
      archiveDrop.classList.add('dragover');
    });
    ['dragleave','drop'].forEach(evt => {
      archiveDrop.addEventListener(evt, () => {
        archiveDrop.classList.remove('dragover');
      });
    });
    archiveDrop.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      if (!dt) return;
      if (dt.files && dt.files.length > 0) {
        const file = dt.files[0];
        handleArchiveFile(file);
      }
    });

    async function handleArchiveFile(file) {
      // Reset previous state
      archiveEntries = [];
      selectedEntries = [];
      archiveList.innerHTML = '';
      extractSummary.textContent = '';
      extractProgressContainer.classList.add('hidden');
      extractProgressBar.style.width = '0%';
      extractProgressText.textContent = '';
      btnDownloadSelected.disabled = true;
      btnSelectAll.disabled = true;
      btnDeselectAll.disabled = true;

      // Validate extension
      const ext = file.name.split('.').pop().toLowerCase();
      if (ext !== 'zip' && ext !== 'rar') {
        alert('Seleziona un file .zip o .rar');
        return;
      }
      archiveInfo.classList.remove('hidden');

      try {
        // Open archive via Unarchiver (loads necessary libs)
        const archive = await Unarchiver.open(file);
        const entries = archive.entries.filter(e => e.is_file);
        archiveEntries = entries;
        // Default: all selected
        selectedEntries = entries.map((_, idx) => idx);
        // Render list
        renderArchiveList();
        updateExtractSummary();
        btnDownloadSelected.disabled = entries.length === 0;
        btnSelectAll.disabled = entries.length === 0;
        btnDeselectAll.disabled = entries.length === 0;
      } catch (err) {
        console.error(err);
        alert('Errore nell\'apertura dell\'archivio: ' + err.message);
      }
    }

    function renderArchiveList() {
      archiveList.innerHTML = '';
      archiveEntries.forEach((entry, idx) => {
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between py-1 border-b';
        // Checkbox
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = selectedEntries.includes(idx);
        cb.className = 'mr-2';
        cb.style.accentColor = 'var(--brand)';
        cb.addEventListener('change', () => {
          if (cb.checked) {
            if (!selectedEntries.includes(idx)) selectedEntries.push(idx);
          } else {
            selectedEntries = selectedEntries.filter(i => i !== idx);
          }
          updateExtractSummary();
        });
        // Name and sizes
        const infoDiv = document.createElement('div');
        infoDiv.className = 'flex-1 overflow-hidden';
        const nameSpan = document.createElement('span');
        nameSpan.textContent = entry.name;
        nameSpan.className = 'block truncate text-sm text-gray-800';
        const sizeSpan = document.createElement('span');
        const compressed = entry.size_compressed || 0;
        const uncompressed = entry.size_uncompressed || 0;
        sizeSpan.textContent = `${humanReadable(uncompressed)} (compresso: ${humanReadable(compressed)})`;
        sizeSpan.className = 'block text-xs text-gray-500';
        infoDiv.appendChild(nameSpan);
        infoDiv.appendChild(sizeSpan);
        // Download single button
        const dlBtn = document.createElement('button');
        dlBtn.textContent = 'Scarica';
        dlBtn.className = 'text-sm px-2 py-1 border rounded';
        dlBtn.style.borderColor = 'var(--brand)';
        dlBtn.style.color = 'var(--brand)';
        dlBtn.addEventListener('click', async () => {
          dlBtn.disabled = true;
          dlBtn.textContent = '...';
          try {
            const fileObj = await entry.read();
            const data = await fileObj.arrayBuffer();
            const blob = new Blob([data], { type: fileObj.type || 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = entry.name;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 1000);
          } catch(err) {
            alert('Errore nel download del file: ' + err.message);
          }
          dlBtn.textContent = 'Scarica';
          dlBtn.disabled = false;
        });
        // Compose row
        row.appendChild(cb);
        row.appendChild(infoDiv);
        row.appendChild(dlBtn);
        archiveList.appendChild(row);
      });
    }

    function updateExtractSummary() {
      // Compute number selected and total size estimated
      let totalSelected = selectedEntries.length;
      let totalSize = 0;
      selectedEntries.forEach(idx => {
        const entry = archiveEntries[idx];
        totalSize += entry.size_uncompressed || 0;
      });
      extractSummary.textContent = `Selezionati: ${totalSelected} • Totale non compresso: ${humanReadable(totalSize)}`;
      // Update download button state
      btnDownloadSelected.disabled = totalSelected === 0;
    }

    btnSelectAll.addEventListener('click', () => {
      selectedEntries = archiveEntries.map((_, idx) => idx);
      renderArchiveList();
      updateExtractSummary();
    });
    btnDeselectAll.addEventListener('click', () => {
      selectedEntries = [];
      renderArchiveList();
      updateExtractSummary();
    });

    btnDownloadSelected.addEventListener('click', async () => {
      if (selectedEntries.length === 0) return;
      // Prepare progress UI
      extractProgressContainer.classList.remove('hidden');
      extractProgressBar.style.width = '0%';
      extractProgressText.textContent = '';
      const zip = new JSZip();
      // Read selected files sequentially
      for (let i = 0; i < selectedEntries.length; i++) {
        const idx = selectedEntries[i];
        const entry = archiveEntries[idx];
        extractProgressBar.style.width = `${Math.round((i / selectedEntries.length) * 50)}%`;
        extractProgressText.textContent = `Lettura file ${i+1}/${selectedEntries.length}…`;
        try {
          const fileObj = await entry.read();
          const data = await fileObj.arrayBuffer();
          // Put into zip preserving path
          zip.file(entry.name, data);
        } catch(err) {
          console.error(err);
        }
      }
      // Create zip
      extractProgressText.textContent = 'Creazione ZIP…';
      await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } }, (metadata) => {
        // metadata.percent: progress from 0-100
        extractProgressBar.style.width = `${50 + Math.round(metadata.percent / 2)}%`;
      }).then((blob) => {
        // Download result
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'estratti.zip';
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 2000);
      });
      extractProgressBar.style.width = '100%';
      extractProgressText.textContent = 'Completato';
    });

    // Creation variables
    const filesInput = document.getElementById('filesInput');
    const filesList = document.getElementById('filesList');
    const zipNameInput = document.getElementById('zipName');
    const zipLevelSelect = document.getElementById('zipLevel');
    const btnCreateZip = document.getElementById('btnCreateZip');
    const createSummary = document.getElementById('createSummary');
    const createProgressContainer = document.getElementById('createProgressContainer');
    const createProgressBar = document.getElementById('createProgressBar');
    const createProgressText = document.getElementById('createProgressText');
    let createFiles = [];

    filesInput.addEventListener('change', (e) => {
      const list = Array.from(e.target.files || []);
      createFiles = list;
      renderFilesList();
    });

    function renderFilesList() {
      if (createFiles.length === 0) {
        filesList.classList.add('hidden');
        createSummary.textContent = '';
        return;
      }
      filesList.classList.remove('hidden');
      filesList.innerHTML = '';
      let totalSize = 0;
      createFiles.forEach(file => {
        totalSize += file.size;
        const row = document.createElement('div');
        row.className = 'flex justify-between border-b py-1';
        const nameSpan = document.createElement('span');
        nameSpan.textContent = file.webkitRelativePath || file.name;
        nameSpan.className = 'flex-1 truncate text-sm text-gray-800';
        const sizeSpan = document.createElement('span');
        sizeSpan.textContent = humanReadable(file.size);
        sizeSpan.className = 'text-xs text-gray-500';
        row.appendChild(nameSpan);
        row.appendChild(sizeSpan);
        filesList.appendChild(row);
      });
      createSummary.textContent = `File selezionati: ${createFiles.length} • Totale: ${humanReadable(totalSize)}`;
    }

    btnCreateZip.addEventListener('click', async () => {
      if (createFiles.length === 0) {
        alert('Seleziona almeno un file o una cartella');
        return;
      }
      const name = zipNameInput.value.trim() || 'archivio';
      const level = parseInt(zipLevelSelect.value, 10);
      // Show progress UI
      createProgressContainer.classList.remove('hidden');
      createProgressBar.style.width = '0%';
      createProgressText.textContent = '';
      const zip = new JSZip();
      // Add files
      for (let i = 0; i < createFiles.length; i++) {
        const file = createFiles[i];
        // Determine path (use webkitRelativePath if available to keep directory structure)
        const filePath = file.webkitRelativePath || file.name;
        createProgressBar.style.width = `${Math.round((i / createFiles.length) * 50)}%`;
        createProgressText.textContent = `Lettura file ${i+1}/${createFiles.length}…`;
        const data = await file.arrayBuffer();
        zip.file(filePath, data);
      }
      // Generate zip
      createProgressText.textContent = 'Creazione ZIP…';
      await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: level } }, (metadata) => {
        createProgressBar.style.width = `${50 + Math.round(metadata.percent / 2)}%`;
      }).then((blob) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = name + '.zip';
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 2000);
      });
      createProgressBar.style.width = '100%';
      createProgressText.textContent = 'Completato';
    });
  </script>
</body>
</html>
