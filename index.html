<!-- ===== EXTRACT (fixed) ===== -->
<script>
  const extractInput = $('#extractInput');
  const extractDrop = $('#extractDrop');
  const entriesList = $('#entriesList');
  const entriesSummary = $('#entriesSummary');
  const btnSelectAll = $('#btnSelectAll');
  const btnSelectNone = $('#btnSelectNone');
  const btnDownloadSelected = $('#btnDownloadSelected');
  const extractProgress = $('#extractProgress');
  const extractProgressBar = $('#extractProgressBar');
  const extractProgressText = $('#extractProgressText');

  let archive = null;                  // Unarchiver archive
  let archiveEntries = [];             // [{ name, size, read:()=>Promise<File> }]
  let selectedEntries = [];            // [name, ...]

  function showExtractProgress(pct, msg=''){
    extractProgress.classList.remove('hidden');
    extractProgressBar.style.width = Math.max(0, Math.min(100, pct)) + '%';
    extractProgressText.textContent = msg;
  }
  function hideExtractProgress(){
    extractProgress.classList.add('hidden');
    extractProgressBar.style.width = '0%';
    extractProgressText.textContent = '';
  }

  async function openArchive(file){
    entriesList.innerHTML = '<div class="p-3 text-sm">Lettura archivio…</div>';
    entriesSummary.textContent = '';
    hideExtractProgress();
    archiveEntries = [];
    selectedEntries = [];
    btnDownloadSelected.disabled = true;

    try {
      archive = await Unarchiver.open(file); // auto ZIP/RAR
      entriesList.innerHTML = '';

      let count = 0, total = 0;

      for (const entry of archive.entries) {
        if (!entry.is_file) continue;                    // <-- usa is_file
        const name = entry.name;                         // <-- usa name
        const size = entry.size_uncompressed || 0;       // <-- usa size_uncompressed
        count++; total += size;

        const row = document.createElement('label');
        row.className = 'flex items-center gap-3 px-3 py-2 text-sm';
        row.innerHTML = `
          <input type="checkbox" class="sel" data-name="${name}">
          <span class="flex-1 truncate mono" title="${name}">${name}</span>
          <span class="text-gray-500">${human(size)}</span>
          <button class="text-blue-600 hover:underline dl" data-name="${name}">scarica</button>
        `;
        entriesList.appendChild(row);

        // Salviamo il reader per il download
        archiveEntries.push({
          name, size,
          read: () => entry.read() // Promise<File>
        });
      }

      entriesSummary.textContent = count ? `${count} file • ${human(total)}` : 'Nessun file';

      // Eventi su checkbox/dl creati dinamicamente
      $$('#entriesList .sel').forEach(c => c.addEventListener('change', refreshSelection));
      $$('#entriesList .dl').forEach(b => b.addEventListener('click', onDownloadSingle));
    } catch (err) {
      entriesList.innerHTML = `<div class="p-3 text-sm text-red-600">Errore apertura archivio: ${err}</div>`;
    }
  }

  function refreshSelection(){
    selectedEntries = $$('#entriesList .sel')
      .filter(c => c.checked)
      .map(c => c.dataset.name);
    btnDownloadSelected.disabled = selectedEntries.length === 0;
  }

  async function onDownloadSingle(e){
    const name = e.currentTarget.dataset.name;
    const ent = archiveEntries.find(x => x.name === name);
    if (!ent) return;
    const file = await ent.read();                       // File
    downloadBlob(name.split('/').pop() || 'file', file); // scarica singolo
  }

  // Input file
  extractInput.addEventListener('change', e => {
    const f = e.target.files?.[0];
    if (f) openArchive(f);
  });

  // Drag&Drop
  ['dragenter','dragover'].forEach(evt =>
    extractDrop.addEventListener(evt, e => { e.preventDefault(); extractDrop.classList.add('bg-white'); })
  );
  ['dragleave','drop'].forEach(evt =>
    extractDrop.addEventListener(evt, e => { e.preventDefault(); extractDrop.classList.remove('bg-white'); })
  );
  extractDrop.addEventListener('drop', e => {
    const f = e.dataTransfer?.files?.[0];
    if (f) openArchive(f);
  });

  // Seleziona/Deseleziona tutto
  btnSelectAll.addEventListener('click', () => {
    $$('#entriesList .sel').forEach(c => c.checked = true);
    refreshSelection();
  });
  btnSelectNone.addEventListener('click', () => {
    $$('#entriesList .sel').forEach(c => c.checked = false);
    refreshSelection();
  });

  // Scarica selezionati (uno per uno, niente ZIP)
  btnDownloadSelected.addEventListener('click', async () => {
    if (!selectedEntries.length) return;
    showExtractProgress(0, 'Preparazione download…');

    for (let i = 0; i < selectedEntries.length; i++){
      const name = selectedEntries[i];
      const ent = archiveEntries.find(x => x.name === name);
      if (!ent) continue;

      const file = await ent.read();
      downloadBlob(name.split('/').pop() || 'file', file);

      const pct = Math.round(((i + 1) / selectedEntries.length) * 100);
      showExtractProgress(pct, `Scaricamento ${i + 1}/${selectedEntries.length}…`);
    }
    setTimeout(hideExtractProgress, 400);
  });
</script>
